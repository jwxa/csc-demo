package com.github.jwxa.config;

import lombok.extern.slf4j.Slf4j;
import org.redisson.api.RBucket;
import org.redisson.api.RClientSideCaching;
import org.redisson.api.RLocalCachedMap;
import org.redisson.api.RMapCache;
import org.redisson.api.RedissonClient;
import org.redisson.api.listener.TrackingListener;
import org.redisson.api.options.ClientSideCachingOptions;
import org.redisson.api.options.LocalCachedMapOptions;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.time.Duration;

/**
 * 独立的近端缓存实验配置，避免直接修改现有 {@code controller/config} 代码。
 * 提供专用的 Redisson 结构用于场景演练。
 */
@Configuration
@Slf4j
public class ScenarioNearCacheConfig {

    private static final String LOCAL_MAP_NAME = "scenario:near-local-map";
    private static final String MAP_CACHE_NAME = "scenario:near-map-cache";
    private static final String CSC_BUCKET_NAME = "scenario:client-side-cache-bucket";

    @Bean
    public RLocalCachedMap<String, String> scenarioLocalCachedMap(RedissonClient client) {
        LocalCachedMapOptions<String, String> options = LocalCachedMapOptions.<String, String>defaults()
                .cacheSize(512)
                .timeToLive(Duration.ofMinutes(5))
                .maxIdle(Duration.ofMinutes(2))
                .reconnectionStrategy(LocalCachedMapOptions.ReconnectionStrategy.CLEAR)
                .syncStrategy(LocalCachedMapOptions.SyncStrategy.INVALIDATE)
                .evictionPolicy(LocalCachedMapOptions.EvictionPolicy.LRU)
                .cacheProvider(LocalCachedMapOptions.CacheProvider.CAFFEINE);

        RLocalCachedMap<String, String> localCachedMap = client.getLocalCachedMap(LOCAL_MAP_NAME, options);
        localCachedMap.addListener((TrackingListener) name ->
                log.info("[ScenarioNearCacheConfig] local cache tracking event -> {}", name));
        return localCachedMap;
    }

    @Bean
    public RMapCache<String, String> scenarioRMapCache(RedissonClient client) {
        return client.getMapCache(MAP_CACHE_NAME);
    }

    @Bean
    public RBucket<String> scenarioClientSideCachingBucket(RedissonClient client) {
        ClientSideCachingOptions options = ClientSideCachingOptions.defaults()
                .size(256)
                .timeToLive(Duration.ofMinutes(2))
                .maxIdle(Duration.ofMinutes(5));

        RClientSideCaching csc = client.getClientSideCaching(options);
        RBucket<String> bucket = csc.getBucket(CSC_BUCKET_NAME);
        bucket.addListener((TrackingListener) name ->
                log.info("[ScenarioNearCacheConfig] CSC tracking event -> {}", name));
        return bucket;
    }
}

